name: Spec & Lint

on:
  push:
    paths:
      - .github/workflows/specs.yml
      - lib/**
      - spec/**
      - Gemfile
      - "*.gemspec"
      - ".rubocop.yml"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: "4.0"
    - name: Install bundler
      run: gem install standard
    - name: Run standardrb
      run: standardrb

  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ruby:
          - "2.4"
          - "2.5"
          - "2.6"
          - "2.7"
          - "3.0"
          - "3.1"
          - "3.2"
          - "3.3"
          - "3.4"
          - "4.0"
          - "head"
          - "jruby-9.4"
          - "jruby-10"
          - "truffleruby"
    steps:
    - uses: actions/checkout@v4
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{matrix.ruby}}
        bundler-cache: true
    - if: ${{ matrix.ruby == 'truffleruby' }}
      name: Ruby specs
      run: bundle exec rspec
    - if: ${{ matrix.ruby != 'truffleruby' }}
      name: Run all tests
      run: bundle exec rake

  coverage:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: "4.0"
        bundler-cache: true
    - name: Run all tests
      env:
        COVERAGE: "true"
      run: bundle exec rspec
    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}

  mutant:
    name: Mutant
    runs-on: ubuntu-latest
    needs: [test, coverage]
    continue-on-error: true
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        ruby: ["3.0", "3.1", "3.2", "3.3", "3.4", "4.0"]
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{matrix.ruby}}
        bundler-cache: true
    - run: bundle exec mutant run --since HEAD~1 --zombie
