name: Spec & Lint

on:
  push:
    paths:
      - .github/workflows/specs.yml
      - lib/**
      - spec/**
      - Gemfile
      - "*.gemspec"
      - ".rubocop.yml"

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: "3.4"
    - name: Install bundler
      run: gem install standard
    - name: Run standardrb
      run: standardrb

  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        ruby:
          - "2.4"
          - "2.5"
          - "2.6"
          - "2.7"
          - "3.0"
          - "3.1"
          - "3.2"
          - "3.3"
          - "3.4"
          - "head"
          - "jruby-9.4"
          - "jruby-10"
          - "truffleruby"
    steps:
    - uses: actions/checkout@v4
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{matrix.ruby}}
        bundler-cache: true
    - if: ${{ matrix.ruby == 'truffleruby' }}
      name: Ruby specs
      run: bundle exec rspec
    - if: ${{ matrix.ruby != 'truffleruby' }}
      name: Run all tests
      run: bundle exec rake

  coverage:
    runs-on: ubuntu-latest
    needs: test
    steps:
    - uses: actions/checkout@v4
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: "3.4"
        bundler-cache: true
    - name: Download test reporter
      run: |
        mkdir -p tmp/
        curl -L https://codeclimate.com/downloads/test-reporter/test-reporter-latest-linux-amd64 > ./tmp/cc-test-reporter
        chmod +x ./tmp/cc-test-reporter
        ./tmp/cc-test-reporter before-build
    - name: Run all tests
      env:
        COVERAGE: "true"
      run: bundle exec rspec
    - name: Send coverage results
      env:
        CC_TEST_REPORTER_ID: ${{secrets.CC_TEST_REPORTER_ID}}
        GIT_COMMIT_SHA: ${{github.sha}}
        GITHUB_REF: ${{github.ref}}
        GIT_COMMITTED_AT: ${{github.event.head_commit.timestamp}}
      run: |
        export GIT_BRANCH=`ruby -e "puts ENV['GITHUB_REF'].split('/', 3).last"`
        export GIT_COMMITTED_AT=`ruby -r time -e "puts Time.iso8601(ENV['GIT_COMMITTED_AT']).to_i"`
        echo "branch: $GIT_BRANCH"
        echo "date: $GIT_COMMITTED_AT"
        ./tmp/cc-test-reporter after-build -t simplecov

  mutant:
    name: Mutant
    runs-on: ubuntu-latest
    needs: [test, coverage]
    continue-on-error: true
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        ruby: ["3.0", "3.1", "3.2", "3.3", "3.4"]
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 2
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{matrix.ruby}}
        bundler-cache: true
    - run: bundle exec mutant run --since HEAD~1 --zombie
