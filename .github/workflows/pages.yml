name: pages

on:
  push:
    branches:
      - master
      - byexample
    paths:
      - .github/workflows/pages.yml
      - _pages/**
      - Gemfile
      - "*.gemspec"
      - bin/byexample

jobs:
  build-docs:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Set up Ruby
      uses: actions/setup-ruby@v1
      with:
        ruby-version: '2.7'
    - name: Setup python
      uses: actions/setup-python@v1
      with:
        python-version: '3.x'
    - name: Bundle install
      run: |
        gem install bundler
        bundle install --jobs 4 --retry 3 --without test
    - name: Install mkdocs and byexample requirements
      run: |
        pip3 install -r _pages/requirements.txt
    - name: Test doc samples
      run: ./bin/byexample
    - name: config git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    - name: deploy pages
      env:
        INPUT_GITHUB_TOKEN: "${{ secrets.DEPLOY_TOKEN }}"
      run: |
        git remote set-url origin https://git:${INPUT_GITHUB_TOKEN}@github.com/fnordfish/teckel.git
        cd _pages
        mkdocs gh-deploy
